<%- include('partials/header') %>

<div class="voting-page">
    <div class="container">
        <header class="page-header">
            <div class="header-content">
                <div class="header-main">
                    <h2>üó≥Ô∏è Active Polls</h2>
                    <% if (session && session.username) { %>
                        <p class="user-welcome">Welcome, <strong><%= session.username %></strong>! 
                        <% if (session.role) { %>
                            <span style="background: <%= session.role === 'admin' ? '#ef4444' : session.role === 'editor' ? '#f59e0b' : '#10b981' %>; color: white; padding: 2px 8px; border-radius: 4px; font-size: 12px; margin-left: 8px;"><%= session.role.toUpperCase() %></span>
                        <% } %>
                        </p>
                    <% } %>
                </div>
                <div class="header-actions">
                    <a href="/account" class="btn btn-secondary" style="background: #667eea; color: white;">üë§ My Account</a>
                    <a href="/results" class="btn btn-secondary">View Results</a>
                    <a href="/logout" class="btn btn-outline">Logout</a>
                </div>
            </div>
        </header>
        
        <!-- Email Verification Warning -->
        <% if (session && session.userId && !session.emailVerified) { %>
            <div style="background: #fff3cd; border: 2px solid #ffc107; border-radius: 12px; padding: 16px; margin-bottom: 24px; display: flex; align-items: center; gap: 12px;">
                <div style="font-size: 24px;">‚ö†Ô∏è</div>
                <div style="flex: 1;">
                    <strong style="color: #856404; display: block; margin-bottom: 4px;">Email Verification Required</strong>
                    <p style="color: #856404; margin: 0; font-size: 14px;">Please verify your email address to cast votes. Check your email for the verification link.</p>
                </div>
                <form action="/resend-verification" method="POST" style="margin: 0;">
                    <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                    <button type="submit" style="background: #ffc107; color: #856404; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 500; white-space: nowrap;">üìß Resend Email</button>
                </form>
            </div>
        <% } else if (session && session.userId && session.emailVerified) { %>
            <div style="background: #d1fae5; border: 2px solid #10b981; border-radius: 12px; padding: 12px 16px; margin-bottom: 24px; display: flex; align-items: center; gap: 8px;">
                <span style="color: #065f46; font-size: 16px;">‚úì</span>
                <span style="color: #065f46; font-weight: 500; font-size: 14px;">Email verified - You can now vote on polls</span>
            </div>
        <% } %>

        <div class="polls-grid">
            <% if (!poll) { %>
                <div class="empty-state">
                    <div class="icon">üìä</div>
                    <h3>No Active Polls</h3>
                    <p>There are no polls available for voting at the moment. Please check back later!</p>
                </div>
            <% } else { %>
                <div class="card poll-card <%= hasVoted ? 'poll-voted' : '' %>">
                    <div class="card-header">
                        <h3 class="poll-title"><%= poll.question %></h3>
                        <% if (hasVoted) { %>
                            <span class="voted-badge">‚úì Voted</span>
                        <% } %>
                    </div>
                    
                    <% if (hasVoted) { %>
                        <div class="already-voted-message">
                            <p><strong>‚úì You voted for: <%= userVote %></strong></p>
                            <p class="results-link"><a href="/results">View all results ‚Üí</a></p>
                        </div>
                        
                        <!-- Show options in read-only mode -->
                        <div class="options-list disabled">
                            <% poll.options.forEach((option, index) => { %>
                                <div class="option-item <%= option === userVote ? 'selected' : '' %>">
                                    <input 
                                        type="radio" 
                                        id="option-<%= poll.id %>-<%= index %>" 
                                        name="option" 
                                        value="<%= index %>" 
                                        <%= option === userVote ? 'checked' : '' %>
                                        disabled
                                        class="radio-input"
                                    >
                                    <label 
                                        for="option-<%= poll.id %>-<%= index %>"
                                        class="radio-label"
                                    >
                                        <%= option %>
                                        <% if (option === userVote) { %>
                                            <span class="vote-marker">‚úì Your Vote</span>
                                        <% } %>
                                    </label>
                                </div>
                            <% }) %>
                        </div>
                    <% } else { %>
                        <form action="/vote" method="POST" class="vote-form" novalidate>
                            <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                            <input type="hidden" name="pollId" value="<%= poll.id %>">
                            
                            <div class="options-list">
                                <% poll.options.forEach((option, index) => { %>
                                    <div class="option-item">
                                        <input 
                                            type="radio" 
                                            id="option-<%= poll.id %>-<%= index %>" 
                                            name="option" 
                                            value="<%= index %>" 
                                            required
                                            class="radio-input"
                                        >
                                        <label 
                                            for="option-<%= poll.id %>-<%= index %>"
                                            class="radio-label"
                                        >
                                            <%= option %>
                                        </label>
                                    </div>
                                <% }) %>
                            </div>
                            
                            <div class="form-actions">
                                <button type="submit" class="btn btn-primary">
                                    <span class="btn-icon">üìù</span>
                                    Cast Vote
                                </button>
                            </div>
                        </form>
                    <% } %>
                </div>
            <% } %>
        </div>
    </div>
</div>

<%- include('partials/footer') %>
